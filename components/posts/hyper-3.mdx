import DownloadButton from '../DownloadButton.js'
import Caption from '../text/Caption.js'
import Author from '../blog/Author.js'
import Image from '../blog/Image.js'

<div className="heading">
  <h1>Hyper 3</h1>
  <time datetime="2019-05-05">Friday, May 5th 2019</time>
</div>

<ul className="authors">
  <li>
    <Author
      data={{
        name: 'Juan Campa',
        twitter: 'juancampa',
        thumbnail: 'https://zeit.co/api/www/avatar/?u=juan&s=160'
      }}
    />
  </li>
  <li>
    <Author
      data={{
        name: 'Julien Déléan',
        twitter: 'CHaBou69',
        thumbnail: 'https://zeit.co/api/www/avatar/?u=chabou&s=160'
      }}
    />
  </li>
  <li>
    <Author
      data={{
        name: 'Daniel Imms',
        twitter: 'tyriar',
        thumbnail: 'https://zeit.co/api/www/avatar/?u=tyriar&s=160'
      }}
    />
  </li>
</ul>

<hr />

**Hyper 3 is finally out!** The main theme for this release is **performance**.
Download it below to try out Hyper 3 right away, and read on to learn more about
what's new.

<br/>
<br/>

<div>
  <DownloadButton />
  <style jsx>
    {`
      div {
        display: flex;
        justify-content: center;
      }
    `}
  </style>
</div>
<br/>
<br/>
<p>
In this release, we are including several big and small improvements to Hyper 3,
which makes it *really* fast. For those of us who spend a significant amount of
time on the command line, this release is a total game changer.
</p>

<br/>
<br/>
<video
    id="vid"
    src="static/blog/comparison.mp4"
    className="oversize"
    autoPlay
    loop
    muted
    />
 <br/>
<br/>
<br/>

## Getting There

Looking back, for this release, an interesting realisation for our team was the
short time from "let's make this thing faster", to "Holy shell! That's fast!"/

The great thing about building on the web platform, is that tools are efficient and mature —
in this case, the DevTools profiler was integral to our process.
The DevTools profiler kept our workflow efficient. We continuously captured CPU
profiles to discover bottlenecks and focused only on the issues that mattered.

Below, we revisit some of the important changes that were shipped in this release:

<br/>
<br/>
<h3>WebGL Renderer</h3>

The WebGL renderer is the piece of code that draws actual pixels on the screen based on the state of the terminal.
The original Hyper renderer used the DOM — a flexible approach (thanks to CSS), but slow.

Hyper 2 improved upon this by switching from `hterm` to `xterm.js` and its
canvas-based renderer, which made it much faster. We knew it was
possible to deliver faster performance by completely rewriting the renderer using
[WebGL](https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API).
By a fortunate coincidence, as we were figuring that out for Hyper 3,
[@Tyriar](https://github.com/tyriar) (from `xterm.js` and `VSCode` fame), [just returned from a "vacation"](https://twitter.com/Tyriar/status/1064932797016489984)
where he happened to be write a shiny new WebGL renderer. Isn't the open source
community just amazing?

We immediately merged @Tyriar's branch onto a test fork, and well,
it ran circles around Hyper 2. Thanks [@Tyriar](https://twitter.com/Tyriar)!

Currently, there are minor limitations with this renderer (selection is always black-and-white,
and you can't have more than 16 terminals visible simultaneously) but we think the performance
benefits vastly outweigh them.

The new renderer is still work-in-progress, so you can expect further improvements in the near future.

<br/>
<br/>
<h3>IPC Batching</h3>

We discovered was that commands that were very verbose would cause
Hyper to temporarily choke for a few seconds. For example,
running `find ~` would cause Hyper to:

- Run painfully slow for ~5 seconds (at ~1 frame-per-second)
- Suddenly get faster (at ~15 frames-per-second) and finish printing everything in ~10 seconds.

Digging within the CPU profile, we noticed that the "renderer" process was
spending most of its time handling an overwhelming amount of messages coming
in from the main process.

<Image  width={5469 / 3} height={1297 / 3} src="static/blog/hyper2.png" caption="Hyper 2"/>
<Image  width={5469 / 3} height={1297 / 3} src="static/blog/hyper3.png" caption="Hyper 3"/>
<Caption>
  It is easy to see the difference between Hyper 2 and 3.
  <br/>
  The pink segments represent the time spent in processing IPC, instead of parsing
  or rendering.
</Caption>

Electron uses a multi-process architecture where each window runs on its own separate
process called a "renderer" process.
Additionally, there's one Node.js-based "main" process that communicates directly with
the underlying OS. In order for terminal data to be rendered by Hyper, it must
be passed from the main process to the renderer process using IPC (Inter-Process
Communication).

**Node's IPC, unfortunately, comes with a non-trivial amount of overhead.**
Messages are sent back and forth as **JSON strings**, which must be encoded on
one side and decoded on the other. Not only that, receiving data through IPC is
an async operation and thus queued in v8's event loop. Yielding back to the
event loop each time after processing small messages made matters worse
This repeated IPC caused thrashing when processing bursts of text, like running `cat` on a large file (see upper profile
above).

To mitigate this problem, we came up with a simple solution: batch data into larger chunks
before sending them to the renderer process. IPC batching reduces the number of
messages for verbose commands significantly and allows the renderer to focus on,
well, rendering.
One important consideration was to **batch as much data as possible to reduce the IPC
overhead, but not too much as to introduce perceivable latency**.
With this approach, the renderer process now spends most of its time doing
terminal emulation and rendering instead of processing a IPC messages.
The outcome is a much smoother, and faster terminal.

On a similar vein, we're also testing a new approach to [decide how much data
is parsed](https://github.com/zeit/xterm.js/pull/4/files) before yielding to the
renderer. The idea is to prevent skipped frames for a more responsive terminal.

<br/>
<br/>

<h3>Electron v3</h3>

Hyper 3 bumps the underlying Electron from v1 to v3. We also
tested v4, but a [regression in the Canvas
API](https://bugs.chromium.org/p/chromium/issues/detail?id=683994#c35) forced us
to stay on v3. The upgrade brings in newer versions of V8 and Node.js, and
their corresponding bug fixes.

<br/>
<br/>
<h3>Faster Startup Time</h3>
Hyper 3 improves startup time by creating the first *pseudoterminal (pty)* as
soon as possible. A pty is a facility provided by operating systems to allow programs such as
Hyper to emulate terminals.

In previous versions, Hyper would wait for the Chromium window to open, for
the window to send an "I'm ready" message, and _only then_ create the pty.
As it turns out, those two activities require a substantial amount of time, but
can be done in parallel.

Hyper 3 starts initializing both at the same time, so by the time the window says "I'm ready", the pty
is already warmed-up and ready to be consumed. This gives Hyper 3 a decent boost in launch time
(about 150ms on Linux, potentially better on other platforms).

<br/>
<br/>

<h3>Emoji Support</h3>

If you're on MacOS, you can now press `Command + Control + Space` to get the
emoji popup and [jazz up those commit messages](https://gitmoji.carloscuesta.me/), (or for anything else really, we ❤
emoji).

<Image src="static/blog/supports-emoji.png" width={1062 / 2} height={950 / 2}/>
<br/>
<br/>

## The Road Ahead

Terminals have existed since the 60s, and have been a powerful tool in our workflows.
Their flexibility guarantees that they will remain relevant for years to
come. [We're in for the long haul](https://twitter.com/rauchg/status/1074381303506587650).

Hyper is a new kind of terminal, built on top of web technology, with a focus on
extensibility. This opens new possibilities that can make the CLI experience
[more productive](https://github.com/chabou/hyper-pane) (and [fun](https://github.com/Aaronius/hyper-cat))!

We're excited to keep improving Hyper, both in terms of performance and
capabilities — there's a lot to do. Hyper is completely open source, and we welcome your
[involvement and contribution](https://github.com/zeit/hyper).

<br/>
<br/>

## Acknowledgments

We're genuinely thankful for our open source communities. We're not saying this only because
we are building on top of an incredible set of open source libraries, but also because we find
the helpful ethos of the community very touching.

As soon as the xterm.js folks heard we were working on performance, they jumped right in and helped us with
feedback and several initiatives they had on their side. We would like to extend huge thanks to [@Tyriar](https://github.com/tyriar),
[@Jerch](https://github.com/jerch) and
[@Stanzilla](https://github.com/stanzilla) for their contribution and feedback.

<br/>
<br/>
